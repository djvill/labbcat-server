<lib-layer-checkboxes
  name="layer" includeAlignment="true"
  span="true" phrase="true" word="true" segment="true"
  excludeMainParticipant="true" 
  category="true"
  [(selected)]="selectedLayerIds"
  (selectedChange)="syncSelectedLayerIdsWithColumns($event)"
  ></lib-layer-checkboxes>

<div class="columns">
  <div class="column" *ngFor="let column of columns; index as c">
    <div class="layers">
      <fieldset *ngFor="let layerId of selectedLayerIds"
                class="layer {{layerId}}"
                [class.spanning]="isSpanningLayer(schema.layers[layerId])"
                [class.anchor-start]="column.layers[layerId][0].anchorStart"
                [class.anchor-end]="column.layers[layerId][column.layers[layerId].length -1].anchorEnd"
                title="{{schema.layers[layerId].description}}">
        <legend>{{layerId}}</legend>
        <div class="layer">
          <span *ngIf=isSpanningLayer(schema.layers[layerId])
                i18n-title title="Anchor to start of {{layerId}} span"
                class="anchor-start"> <!-- first match in column -->
            <img [src]="'assets/lock-'+(column.layers[layerId][0].anchorStart?'locked':'unlocked')+'.svg'"
                 [alt]="column.layers[layerId][0].anchorStart?'ðŸ”’':'ðŸ”“'"
                 (click)="column.layers[layerId][0].anchorStart = !column.layers[layerId][0].anchorStart"
                 >
          </span>
          <div class="match" *ngFor="let match of column.layers[layerId]">
            <span *ngIf="schema.layers[layerId].alignment > 0 && layerId != schema.turnLayerId && layerId != schema.utteranceLayerId"
                  class="target"
                  i18n-title title="Target this match">
              <img
                i18n-title title="Target this match"
                alt="ðŸŽ¯" src="assets/target.svg"
                [class]="match.target?'selected':'deselected'"
                (click)="setTarget(match)">
            </span>
            <ng-container
              *ngIf="layerId != schema.turnLayerId && layerId != schema.utteranceLayerId"
              [ngSwitch]="schema.layers[layerId].type">

              <span *ngSwitchCase="'number'" class="numeric">
                <span className="ge">&ge;</span>
                <input
                  class="numeric minimum"
                  type="number"
                  i18n-placeholder placeholder="Minimum"                  
                  [(value)]="match.min">
                <span className="lt">&lt;</span>
                <input
                  class="numeric maximum"
                  type="number"
                  i18n-placeholder placeholder="Maximum"
                  [(value)]="match.max">
              </span>

              <span *ngSwitchCase="'ipa'" class="ipa">
                <span class="not">
                  <select class="not"
                          i18n-title title="match or not"
                          [(ngModel)]="match.not">
                    <option value="false" i18n>matches</option>
                    <option value="true" i18n>doesn't match</option>
                  </select>
                </span>
                <span class="match">
                  <lib-input-regexp
                    type="text"
                    i18n-placeholder placeholder="Regular expression"
                    [(value)]="match.pattern"></lib-input-regexp>
                </span>
                <span class="help">
                  <lib-button
                    i18n-title title="Phoneme symbol selector"
                    icon="Â«" [img]="helperMatch == match?'collapse-down.svg':'expand-down.svg'"
                    (press)="helperMatch = (helperMatch == match?null:match)"></lib-button>
                  <lib-disc-helper
                    *ngIf="!hasValidLabels(schema.layers[layerId]) && helperMatch == match"
                    (symbolSelected)="appendToPattern(match, $event)"></lib-disc-helper>
                  <lib-valid-label-helper
                    *ngIf="hasValidLabels(schema.layers[layerId]) && helperMatch == match"
                    [layer]="schema.layers[layerId]"
                    (symbolSelected)="appendToPattern(match, $event)"></lib-valid-label-helper>
                </span>
              </span>

              <span *ngSwitchDefault class="regexp">
                <span class="not">
                  <select class="not"
                          i18n-title title="match or not"
                          [(ngModel)]="match.not">
                    <option value="false" i18n>matches</option>
                    <option value="true" i18n>doesn't match</option>
                  </select>
                </span>
                <span class="match">
                  <lib-input-regexp
                    type="text" className="string"
                    [(value)]="match.pattern"></lib-input-regexp>
                </span>
                <span class="help" *ngIf="hasValidLabels(schema.layers[layerId])">
                  <lib-button
                    i18n-title title="Symbol selector"
                    icon="Â«" [img]="helperMatch == match?'collapse-down.svg':'expand-down.svg'"
                    (press)="helperMatch = (helperMatch == match?null:match)"></lib-button>
                  <lib-valid-label-helper
                    *ngIf="helperMatch == match"
                    [layer]="schema.layers[layerId]"
                    (symbolSelected)="appendToPattern(match, $event)"></lib-valid-label-helper>
                </span>
              </span>
              
            </ng-container> <!-- switch on layer.type -->
          </div>    <!-- match -->
          <span *ngIf=isSpanningLayer(schema.layers[layerId])
                i18n-title title="Anchor to end of {{layerId}} span"
                class="anchor-end"> <!-- last match in column -->
            <img [src]="'assets/lock-'+(column.layers[layerId][column.layers[layerId].length -1].anchorEnd?'locked':'unlocked')+'.svg'"
                 [alt]="column.layers[layerId][column.layers[layerId].length -1].anchorEnd?'ðŸ”’':'ðŸ”“'"
                 (click)="column.layers[layerId][column.layers[layerId].length -1].anchorEnd = !column.layers[layerId][column.layers[layerId].length -1].anchorEnd"
                 >
          </span>
        </div>     <!-- layer -->
      </fieldset> <!-- layerId -->
    </div>  <!-- layers -->
    <div class="adj" *ngIf="c < columns.length - 1">
      <span i18n="'followed' n words later by...">followed</span>
      <select i18n-title title="Distance between matches"
              [(ngModel)]="column.adj">
        <option value="1" i18n="followed 'immediately' by...">immediately</option>
        <option value="2" i18n="followed '1 word later' by...">1 word later</option>
        <option value="3" i18n="followed '2 words later' by...">2 words later</option>
      </select>
      <span i18n="followed n words later 'by'...">by</span>
    </div>
    <div class="add-column"*ngIf="c == columns.length - 1">
      <lib-button
        i18n-title title="Make the search one word wider"
        icon="âž•" img="add.svg"
        (press)="addColumn()"></lib-button>
      <lib-button
        *ngIf="c > 0"
        icon="âž–" img="remove.svg"
        i18n-title title="Make the search one word narrower"
        (press)="removeColumn()"></lib-button>
    </div>
  </div> <!-- column -->
</div> <!-- columns -->
